upstream redis {
  server localhost:6379;
  keepalive 1024;
}

upstream unicorn {
  server unix:/tmp/unicorn.mebeltorg.sock fail_timeout=0;
}

server {
  listen 80;
  server_name mebeltorg.com;
  root /home/deployer/apps/mebeltorg/current/public;

  location = /stat {
    stub_status on;
    access_log  off;
    #allow xx.xx.xx.xx;
    deny all;
  }

  location / {
    set $redis_db "1";
    set $redis_key $host$uri$is_args$args;
    default_type   text/html;
    redis_pass redis;
    error_page 404 405 502 504 = @fallback;
  }

  location @fallback {
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host $http_host;
    proxy_redirect off;
    if (!-f $request_filename) {
      proxy_pass http://unicorn;
      break;
    }
  }

  location ~* \.(js|css|png|jpg|jpeg|gif|ico|woff)$ {
    gzip_static on;
    expires 1y;
    access_log  off;
    log_not_found off;
    add_header Cache-Control public;
  }
}

# server {
#   server_name mebeltorg.com
#   listen 80 default deferred;
#   # server_name example.com;
#   root /home/deployer/apps/mebeltorg/current/public;
#
#   #location ^~ /assets/ {
#   #  expires 1y;
#   #  add_header Cache-Control public;
#   #}
#
#   location ~* \.(js|css|png|jpg|jpeg|gif|ico)$ {
#     gzip_static on;
#     expires 1y;
#     log_not_found off;
#   }
#
#   try_files $uri/index.html $uri @unicorn;
#   location @unicorn {
#     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#     proxy_set_header Host $http_host;
#     proxy_redirect off;
#     proxy_pass http://unicorn;
#   }
#
#   error_page 500 502 503 504 /500.html;
#   client_max_body_size 4G;
#   #keepalive_timeout 10;
#   keepalive_timeout 75s;
# }
